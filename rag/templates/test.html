<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RAG Chatbot</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://kit.fontawesome.com/5f9f7f5e43.js" crossorigin="anonymous"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center h-screen">
  <div class="bg-white shadow-2xl rounded-2xl w-full max-w-2xl flex flex-col h-[85vh]">

    <!-- Header -->
    <div class="px-6 py-4 border-b flex items-center justify-between">
      <h1 class="text-xl font-semibold text-gray-800">ü§ñ RAG Chatbot</h1>
      <div class="flex items-center space-x-2">
        <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
        <span class="text-sm text-gray-600">Online</span>
      </div>
    </div>

    <!-- Chat Window -->
    <div id="chat-box" class="flex-1 p-4 overflow-y-auto space-y-3">
      <div class="text-center text-gray-400 text-sm">üí¨ Start chatting with me!</div>
    </div>

    <!-- Typing Indicator -->
    <div id="typing-indicator" class="hidden px-4 pb-2">
      <div class="flex items-center space-x-2">
        <div class="bg-gray-200 rounded-2xl px-4 py-2 flex items-center space-x-1">
          <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce"></div>
          <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce delay-150"></div>
          <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce delay-300"></div>
        </div>
      </div>
    </div>

    <!-- Input -->
    <div class="p-4 border-t flex flex-col space-y-2">
      <div class="flex space-x-2">
        <input id="user-input"
               type="text"
               placeholder="Ask me anything..."
               class="flex-1 border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
               onkeypress="handleKeyPress(event)">
        <button onclick="sendMessage()"
                class="bg-indigo-600 text-white rounded-lg px-4 py-2 hover:bg-indigo-700">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>

      <!-- Quick Prompts -->
      <div class="flex flex-wrap gap-2">
        <button onclick="quickQuestion('What is RAG?')" class="px-3 py-1 text-xs border rounded-full hover:bg-gray-100">What is RAG?</button>
        <button onclick="quickQuestion('Give me a summary of my document')" class="px-3 py-1 text-xs border rounded-full hover:bg-gray-100">Summarize</button>
        <button onclick="quickQuestion('How can AI help my business?')" class="px-3 py-1 text-xs border rounded-full hover:bg-gray-100">Business</button>
      </div>
    </div>
  </div>

  <script>
    let isTyping = false;

    function handleKeyPress(event) {
      if (event.key === "Enter" && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }

    function quickQuestion(q) {
      document.getElementById("user-input").value = q;
      sendMessage();
    }

    function showTyping() {
      document.getElementById("typing-indicator").classList.remove("hidden");
    }
    function hideTyping() {
      document.getElementById("typing-indicator").classList.add("hidden");
    }

    async function sendMessage() {
      const input = document.getElementById("user-input");
      const chatBox = document.getElementById("chat-box");
      if (!input.value.trim() || isTyping) return;

      // Remove placeholder if first message
      if (chatBox.children.length === 1 && chatBox.firstChild.classList.contains("text-center")) {
        chatBox.innerHTML = "";
      }

      // Append user message
      const userDiv = document.createElement("div");
      userDiv.className = "flex justify-end";
      userDiv.innerHTML = `
        <div class="max-w-xs bg-indigo-100 text-indigo-800 px-3 py-2 rounded-xl shadow">
          ${escapeHtml(input.value)}
          <p class="text-[10px] text-gray-500 text-right mt-1">${getTime()}</p>
        </div>`;
      chatBox.appendChild(userDiv);

      const message = input.value;
      input.value = "";

      // Show typing
      isTyping = true;
      showTyping();
      chatBox.scrollTop = chatBox.scrollHeight;

      try {
        const res = await fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message })
        });
        const data = await res.json();

        // Hide typing
        hideTyping();
        isTyping = false;

        // Append bot message
        const botDiv = document.createElement("div");
        botDiv.className = "flex justify-start";
        botDiv.innerHTML = `
          <div class="flex items-start space-x-2 max-w-xs">
            <div class="w-8 h-8 rounded-full bg-indigo-600 text-white flex items-center justify-center">
              <i class="fas fa-robot"></i>
            </div>
            <div>
              <div class="bg-gray-200 text-gray-800 px-3 py-2 rounded-xl shadow">${escapeHtml(data.response)}</div>
              <p class="text-[10px] text-gray-500 mt-1">${getTime()}</p>
            </div>
          </div>`;
        chatBox.appendChild(botDiv);
      } catch (err) {
        hideTyping();
        isTyping = false;
        const errDiv = document.createElement("div");
        errDiv.className = "text-left text-red-500 text-sm";
        errDiv.textContent = "‚ö†Ô∏è Error: could not connect.";
        chatBox.appendChild(errDiv);
      }

      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function escapeHtml(text) {
      const div = document.createElement("div");
      div.textContent = text;
      return div.innerHTML;
    }

    function getTime() {
      const now = new Date();
      return now.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    }
  </script>
</body>
</html>